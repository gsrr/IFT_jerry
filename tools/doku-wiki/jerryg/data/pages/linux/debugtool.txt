====== test case for nt-acl ======

1. Basic setting from EonOne
<file>
  1.1 確認設定是否符合正確行為: (從CIFS進行確認)
    a. ACE scope (This folder / subfolder / files)
    b. 設定ACE + "只需在此資料夾裡的物件與/或容器來套用權限"
    c. 設定ACE + "用此資料夾的物件繼承權取代所有子物件繼承權"
    d. Creator Owner / Creator Group   
</file>

2. 檔案權限操作 (透過cifs)
|Operation|Synology| IFT |
|進入資料夾/列出檔案| 周遊資料夾/執行檔案 + 資料夾/讀取資料夾清單| 周遊資料夾/執行檔案 + 資料夾/讀取資料夾清單| 
|讀取檔案內容|周遊資料夾/執行檔案 + 資料夾/讀取資料夾清單 + 讀取延伸的屬性 | 周遊資料夾/執行檔案 + 資料夾/讀取資料夾清單 + 讀取延伸的屬性| 
|寫入檔案內容|周遊資料夾/執行檔案 + 資料夾/讀取資料夾清單 + 讀取延伸的屬性 + 讀取權限 + 建立檔案/讀取檔案 + 建立資料夾/附加資料 + 寫入屬性延伸| 周遊資料夾/執行檔案 + 資料夾/讀取資料夾清單 + 讀取延伸的屬性 + 讀取權限 + 建立檔案/讀取檔案 + 建立資料夾/附加資料 + 寫入屬性延伸+寫入屬性| 
|讀取屬性| -- | | 
|寫入屬性| -- | | 
|讀取延伸屬性| | | 
|寫入延伸屬性| | | 
|讀取權限|周遊資料夾/執行檔案 + 資料夾/讀取資料夾清單 + 讀取權限 |周遊資料夾/執行檔案 + 資料夾/讀取資料夾清單 + 讀取權限 | 
|寫入權限|周遊資料夾/執行檔案 + 資料夾/讀取資料夾清單 + 讀取權限 + 改變權限 |周遊資料夾/執行檔案 + 資料夾/讀取資料夾清單 + 讀取權限 + 改變權限 + 建立檔案/讀取檔案 |
|變更使用者|周遊資料夾/執行檔案 + 資料夾/讀取資料夾清單 + 讀取權限 + 接管管理者|周遊資料夾/執行檔案 + 資料夾/讀取資料夾清單 + 讀取權限 + 接管管理者 |
|刪除檔案|周遊資料夾/執行檔案 + 資料夾/讀取資料夾清單 + 刪除|周遊資料夾/執行檔案 + 資料夾/讀取資料夾清單 + 刪除 |

2.1 檔案權限操作(透過nfs)
|Operation|Synology| IFT |
|進入資料夾(cd)| 周遊資料夾/執行檔案| | 
|列出檔案(ls)| 資料夾/讀取資料夾清單| | 
|讀取檔案內容|周遊資料夾/執行檔案 + 資料夾/讀取資料夾清單 + 讀取權限 | | 
|寫入檔案內容|周遊資料夾/執行檔案 + 資料夾/讀取資料夾清單 + 建立檔案/讀取檔案 + 建立資料夾/附加資料| | 
|讀取屬性| Not support| | 
|寫入屬性| Not support| | 
|讀取延伸屬性| Not support| | 
|寫入延伸屬性| Not support| | 
|讀取權限|Not support | | 
|寫入權限|Not support | |
|變更使用者(限root)|無關權限||
|刪除檔案|周遊資料夾/執行檔案 + 資料夾/讀取資料夾清單 + 刪除| |

2.1.1 檔案權限操作(透過file explorer)
|Operation|預期權限 | File explorer |
|進入資料夾(cd)| 周遊資料夾/執行檔案| | 
|列出檔案(ls)| 資料夾/讀取資料夾清單| | 
|下載檔案|周遊資料夾/執行檔案 + 資料夾/讀取資料夾清單| | 
|上傳檔案|周遊資料夾/執行檔案 + 資料夾/讀取資料夾清單 + 建立檔案/讀取檔案 + 建立資料夾/附加資料| | 
|讀取權限|周遊資料夾/執行檔案 + 資料夾/讀取資料夾清單 + 讀取權限| | 
|寫入權限|周遊資料夾/執行檔案 + 資料夾/讀取資料夾清單 + 讀取權限 + 改變權限 | |
|變更使用者|周遊資料夾/執行檔案 + 資料夾/讀取資料夾清單 + 讀取權限 + 變更使用者| |
|刪除檔案|周遊資料夾/執行檔案 + 資料夾/讀取資料夾清單 + 刪除| |

2.2 繼承權限確認 (Propagate)
| | subfolder| files|
|This folder|(N, -)|(N,-)|
|Sub folder|(Y, This folder/Sub folder)|(N,-)|
|files|(Y, files)|(Y,-)|
|This folder/Sub folder|(Y, This folder/Sub folder)|(N,-)|
|This folder/files|(Y, files)|(Y,-)|
|Sub folder/files|(Y, This folder/Sub folder/files)|(Y,-)|
|This folder/Sub folder/files|(Y, This folder/Sub folder/files)|(Y,-)|

2.3 繼承權限確認 (No Propagate)
| | subfolder| files|
|This folder|(N, -)|(N,-)|
|Sub folder|(Y, This folder)|(N,-)|
|files|(N, -)|(Y,-)|
|This folder/Sub folder|(Y, This folder)|(N,-)|
|This folder/files|(N, -)|(Y,-)|
|Sub folder/files|(Y, This folder)|(Y,-)|
|This folder/Sub folder/files|(Y, This folder)|(Y,-)|

3. 特殊acl設定(透過nfs)
|Operation|Expected behavior|
|chmod| 視為只對owner, group, everyone進行設定, 只會保留這三個entry權限.|
|chown| 更改owner, acl內容不改變 |
|setfacl|不可執行此項操作|
|setfattrl|不可執行此項操作|

4. 權限檢查(透過nfs)
  4.1 若acl只apply到files, 則該權限不在folder生效.
  4.2 Deny有優先權判斷.
  4.3 user / group / everyone為合併進來進行權限判斷.

5. Behavior of move/copy
| -- |Samba|Syno|linux(file explorer)|nfs|ftp|
|cp|owner改變, 繼承destination folder權限|owner改變, 繼承destination folder權限|owner改變, 繼承destination folder權限|owner改變, 權限不繼承(chmod) | No FTP command |
|move(same share folder)|owner不變, 限定權限 + 繼承destination folder權限|owner不變, 限定權限 + 繼承destination folder權限|owner不變, 權限不變(same volume)| owner不變, 權限不變(same volume)| owner不變, 權限不變|
|move(different share folder)|owner改變, 繼承destination folder權限|owner不變, 繼承destination folder權限|owner不變, 權限不變(different volume)| owner不變, 權限不繼承(會執行chmod)|  Rename failed. |

6. Integrated test with domain
|Operation|AD|LDAP|
|設定domain user的權限| | |
|設定domain group的權限| | |
|login samba, 確認權限顯示符合預期| | |
|login file explorer, 確認權限顯示符合預期| | |
|login samba, 確認權限操作符合預期| | |
|login file explorer, 確認權限操作符合預期| | |


====== python - debug with gdb ======
<file>
[FAQ]
[MAX_OUTPUT_LEN]
1. in python-pdb.py
2. 增加output 的長度

Q4 : 可以用gdb改變程式的fd路徑嗎?
Ans :

Q3 : 如何設定break point?
Ans : 
1. break PyEval_EvalFrameEx if (strcmp((((PyStringObject *)(f->f_code->co_name))->ob_sval), "foo") == 0)
2. (參考 my-gdb.py)
(gdb) py-bk Hello
Breakpoint 1 at 0x7fd390fefb00: file Python/ceval.c, line 759.
(gdb) c
Continuing.
stop

Breakpoint 1, PyEval_EvalFrameEx (
    f=f@entry=Frame 0x7fd3913c33e0, for file test.py, line 3, in Hello (name='Jerry', dic={'test': 2, 'key': 1}),
    throwflag=throwflag@entry=0) at Python/ceval.c:759
759     Python/ceval.c: No such file or directory.
(gdb)

Q2 : 如何印出python的變數內容?
Ans :

Q1 : py-bt print出來的訊息會被truncated, 要如何印出完整的訊息?
for example:
#9 Frame 0x7f759788e578, for file /usr/local/NAS/misc/HAAgent/HAServer.py, line 2913, in main (sys=<module at remote 0x7f75ab374bb0>, server=<HAServer(setInfoLock={'NFSInfo': <thread.lock at remote 0x7f75970f5710>, 'WEBDAVInfo': <thread.lock at remote 0x7f75970f57d0>, 'FTPInfo': <thread.lock at remote 0x7f75970f5750>, 'ServiceInfo': <thread.lock at remote 0x7f75970f5870>, 'MonitorInfo': <thread.lock at remote 0x7f75970f58d0>, 'DiskInfo': <thread.lock at remote 0x7f75970f5bf0>, 'ShareInfo': <thread.lock at remote 0x7f75970f5e70>, 'MDInfo': <thread.lock at remote 0x7f7594064270>, 'AvInfo': <thread.lock at remote 0x7f75940640d0>, 'SystemInfo': <thread.lock at remote 0x7f75970f5cf0>, 'LVMInfo': <thread.lock at remote 0x7f7594064430>, 'UserInfo': <thread.lock at remote 0x7f7594064390>, 'RSYNCDInfo': <thread.lock at remote 0x7f75970f5810>, 'AFPInfo': <thread.lock at remote 0x7f75970f5d50>, 'PasswdManageInfo': <thread.lock at remote 0x7f75970f5a50>, 'NetworkInfo': <thread.lock at remote 0x7f75940642d0>, 'CIFSInfo': <th...(truncated)

Ans:
需修改python-gdb裡面的參數:
MAX_OUTPUT_LEN=1024

[gdb-extension]
1. source python-gdb.py
https://raw.githubusercontent.com/WiserTogether/python27/master/python-gdb.py

2. source py-fields.py
https://gist.github.com/kouk/5c2e725bef8b54aae6e0

[Installation]
1. yum install gdb python-debuginfo
2. yum install yum-utils
3. debuginfo-install glibc
4. debuginfo-install python

[Reference]
1. python - gdb support
https://docs.python.org/devguide/gdb.html

2. gdb python online document
https://sourceware.org/gdb/onlinedocs/gdb/Breakpoints-In-Python.html#Breakpoints-In-Python

3. DebuggingWithGdb
https://wiki.python.org/moin/DebuggingWithGdb

4. Extended gdb using python
https://sourceware.org/gdb/onlinedocs/gdb/Python.html
</file>

====== gdb ======
<file>

[gdb usage]
# go to desired frame number
1. frame frame-number

# gdb print value of whole array
(gdb) p *array@len

(gdb) p/x *blob.data@468
$21 = {0x4, 0x0, 0x4, 0x0, 0x0, 0x0, 0x2, 0x0, 0x4, 0x0, 0x2, 0x0, 0x1, 0x0, 0x26, 0x89, 0x39, 0xba, 0xdd, 0x76, 0x94, 0xf7, 0x30, 0x1e, 0x1e, 0x56, 0x8c,
  0x14, 0x60, 0x73, 0xc5, 0x74, 0xd4, 0x11, 0x98, 0xb6, 0x23, 0xc6, 0xaa, 0xad, 0x6c, 0xa4, 0x58, 0xb3, 0x55, 0x65, 0x0 <repeats 32 times>, 0x70, 0x6f,
  0x73, 0x69, 0x78, 0x5f, 0x61, 0x63, 0x6c, 0x0, 0x4, 0xaa, 0xf7, 0x3d, 0xda, 0x4e, 0xd3, 0x1, 0x76, 0xc4, 0xcc, 0xf8, 0xf8, 0x5b, 0x2a, 0x55, 0x86, 0xae,
  0x49, 0x5b, 0xa1, 0x19, 0x27, 0x1d, 0x60, 0x8f, 0xfe, 0x81, 0x9d, 0x95, 0xa9, 0x6c, 0x18, 0x24, 0x35, 0x40, 0x33, 0x2c, 0xbc, 0x1, 0x0 <repeats 32 times>,
  0x1, 0x0, 0x4, 0x9c, 0xb4, 0x0, 0x0, 0x0, 0xd0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xe0, 0x0, 0x0, 0x0, 0x1, 0x5, 0x0, 0x0, 0x0, 0x0, 0x0, 0x5, 0x15, 0x0,
  0x0, 0x0, 0x9a, 0x51, 0xc0, 0xfd, 0x13, 0xe, 0x69, 0xd1, 0xe9, 0x71, 0xd2, 0xbc, 0xe8, 0x3, 0x0, 0x0, 0x1, 0x2, 0x0, 0x0, 0x0, 0x0, 0x0, 0x16, 0x2, 0x0,
  0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x2, 0x0, 0xf4, 0x0, 0x9, 0x0, 0x0, 0x0, 0x0, 0x3, 0x24, 0x0, 0xff, 0x1, 0x1f, 0x0, 0x1, 0x5, 0x0, 0x0...}

# gdb print hex value
p/x var

# print variable
1. print variable-name
2. p variable-name

# backtrace
1. bt
2. bt full

# x command
Displays the memory contents at a given address using the specified format.

# stop gdb
1. q
2. quit

[Reference]
1. gdb reference
http://visualgdb.com/gdbreference

2. Debugging with gdb
https://sourceware.org/gdb/onlinedocs/gdb/

3. debug for thread, multi-process
http://www.study-area.org/cyril/opentools/opentools/x1265.html

# command
gdb /usr/bin/smbd path/to/the/core

</file>
====== crash ======
<file>
[FAQ]

[BASIC]
# vma
1. vma stands for "virtual memory area".

crash> vm 24518 | more
PID: 24518  TASK: ffff8802b20ddc00  CPU: 0   COMMAND: "python"
       MM               PGD          RSS    TOTAL_VM
ffff880067ee3200  ffff88023671d000  27160k  473304k
      VMA           START       END     FLAGS FILE
ffff88023d2d2ca8     400000     401000    875 /usr/bin/python2.7
ffff88023d2d2bd0     600000     601000 100871 /usr/bin/python2.7
ffff88023d2d2af8     601000     602000 100873 /usr/bin/python2.7
ffff88023d2d2a20    1643000    2167000 100073
ffff880273ec8798    2167000    2189000 100073

ffff88023d2d2ca8 is a pointer address which refer to virtual memory area.
It store the memory that start from 400000 to 401000.


# memory information
1. vm <pid>
2. ps | grpe yas3 | awk '{sum += $8} END {print sum}'

# stack of a process
1. ps | grep rsync
2. bt <pid>

# process information
1. ps

# command
1. crash vmcore vmlinux_kernel2017-10-24_180426_37bc122
</file>