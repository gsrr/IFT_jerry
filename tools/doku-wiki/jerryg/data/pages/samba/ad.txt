====== Reference ======
<file>
# Setting up Samba as a Domain Member
https://wiki.samba.org/index.php/Setting_up_Samba_as_a_Domain_Member#Testing_the_Winbindd_Connectivity
</file>

====== login samba server by kerberos auth ======
<file>
這個問題大概有兩個面向:
1. samba service
1.1 需使用netbios進行login(ip 與netbios的行為不一樣)
ip 會預設走ntlm的方式, netbios則是走kerberos的方式.

1.2 可以使用smbclient進行測試:
(https://cwiki.apache.org/confluence/display/DIRxINTEROP/Using+Kerberos+Credentials+with+smbclient)

a. 先join AD
b. 使用kinit跟AD要一個key : kinit administrator@WINADNTP.EVT
(或使用wbinfo -K administrator%ABcd_1234)
c. smbclient -k //nas_8632830_a/AA -R host -U administrator -d 4


2. other service (透過pam認證, 像sftp, ftp...etc)
2.1 需要先將/etc/security/pam_winbind.conf裡面的kerberos設定enable
(https://wiki.samba.org/index.php/PAM_Kerberos_Authentication)
主要有兩個東西:
krb5_auth = yes
krb5_ccache_type = FILE

2.2 當user登入時,  就會在tmp底下產生一個該user的key file, 像是/tmp/krb5cc_11001703


</file>

====== Event and Error message ======
| | |message|event| |
|AD|Password / Accout Error (Preauthentication failed)| 使用者名稱或密碼不正確。| X | |
|AD| Dns Entry error (Can not find KDC Server) |  X | X | |
|AD| ip error (Can't contact LDAP server)| 無法連到網域伺務器。  | X | |
|AD| account 沒有admin 權限 ( Failed to join domain: Failed to set account flags for machine account (NT_STATUS_ACCESS_DENIED))| X  | X | |
|LDAP| Password (ldap_bind: Invalid credentials) | 使用者名稱或密碼不正確。  | X | |
|LDAP| User Dn error (ldap_bind: Invalid credentials) | 使用者名稱或密碼不正確。 | X | |
|LDAP| ip error (can not contact ldap server)| 無法連接到LDAP伺服器 | X | |
|LDAP| Base Dn error (No such object)| X | X | |





====== acl ======
<file>
# user join group after login
## gs-join group-ad
1. user1 login samba
2. join group (ad)
3. without update user list
ret --> can not access share folder (without relogin)
relogin --> can access share folder

[root@nas_8446485_a ~]# id WINADNTP\\test001
uid=11001369(WINADNTP\test001) gid=11000513(WINADNTP\domain users) groups=11001369(WINADNTP\test001),11000513(WINADNTP\domain users),11001372(WINADNTP\group002)

## gs-join group-ad
1. user1 login samba
2. join group (ad)
3. without update user list
ret --> can not access share folder (without relogin)
relogin --> can access share folder

[root@nas_8446485_a ~]# id WINADNTP\\test001
uid=11001369(WINADNTP\test001) gid=11000513(WINADNTP\domain users) groups=11001369(WINADNTP\test001),11000513(WINADNTP\domain users),11001372(WINADNTP\group002)

## gs-join group-ad
1. user1 login samba
2. user1 join group
3. update user list 
ret --> can not access share folder 
relogin --> can access share folder

## gs without re-login
1. user1 login samba
2. user1 join group (ad)
3. update user list
ret -->

## gs without re-login
1. user1 login samba
2. user1 join group (ad)
3. without update user list
ret --> 
relogin --> 

## gs-join group-ldap
1. user1 login samba
2. user1 join group
3. without update user list 
ret --> can not access share folder (without relogin)
relogin --> can not access share folder

## gs-join group-ldap
1. user1 login samba
2. user1 join group
3. update user list 
ret --> can not access share folder (without relogin)
relogin --> can access share folder

## gs-leave group-ldap
1. user1 login samba
2. user1 leave group
3. without update user list 
ret --> can access share folder (without relogin)
relogin --> can access share folder

## gs-leave group-ldap
1. user1 login samba
2. user1 leave group
3. update user list 
ret --> can access share folder (without relogin)
relogin --> can not can access share folder

## synology without re-login
1. user1 login samba
2. join group
3. waiting time (check user list)
ret --> 


Summary:
1. 一定要重新login才會生效, 不論有update user or not. (nscd -i group)
2. ad跟ldap的行為不太一樣, ad的id command似乎沒有辦法再nscd -i group就更新, 必須要重新login
3. ad只要重新login, 其acl就可以生效, 即便id user沒有更新也沒關係.
3. synology 在add group時, 似乎可以不用重新login, 但leave group時等了15分鐘還是可以操作.

</file>


====== AD take over ======
<file>
172.27.120.180 WIN-2012R2ADC.winadntp.evt
172.27.120.179 WIN-2012R2ADNTP.winadntp.evt
# join AD message
Using short domain name -- WINADNTP
5433 Joined 'NAS_824366_A' to dns domain 'winadntp.evt'
5434 No DNS domain configured for nas_824366_a. Unable to perform DNS Update.)
--> normal message

# failed to join AD
Mar 27 02:42:12 nas_824366_a ldapOperation[2449]: (cmd, out) = (['/usr/bin/net', 'ads', 'join', '-S', 'WIN-2012R2ADC.winadntp.evt', '-U', 'administrator%ABcd_1234', '-s', '/etc/samba/net_smb.conf'], Failed to join domain: Failed to set
machine spn: Constraint violation Do you have sufficient permissions to create machine accounts?)
Mar 27 02:42:12 nas_824366_a diagnosticOperation[2449]: {'status': 71, 'err': '', 'out': 'Failed to join domain: Failed to set machine spn: Constraint violation\nDo you have sufficient permissions to create machine accounts?'}
--> Delete the computer account of AD

Root Cause:
若A, B兩台機器, A join完斷線, 這時候會換join B來進行接手,此時新增加的computer object id與join A時並不一樣,
所以當A起來後, 會多出一個computerCNF的object, 導致若要換成joinA接手時會失敗.

# 另外一個問題是沒辦法透過DNS找不到ip
--> 看起來是因為找到192.168.99.14去了, 導致DNS會一直回覆unknown host.
anyway , 目前測試起來, 應該不需要進行重新join的動作.
只要透過wbinfo -P來讓winbind ping AD, 就可以讓winbind建立正確連線.

test scope:
1. DNS應該只保留查詢得到的nameserver. (192.168.99.14, 192.168.99.16都應該去除)
2. 將AD斷線, 等待約5~10分鐘, 再重新使用AD user來登入samba, 確認該user可以正常登入.

</file>
====== AD related commands ======
<file>
# smbd
1. port 139, port 445

# nmbd
1. port 137, port 138
UDP    172.27.12.71:137       *:*                                    4
UDP    172.27.12.71:138       *:*                                    4

# search workgroup
1. net ads workgroup -S 172.27.120.130
2. nmblookup -A 172.27.l20.130
3. 

# join AD
net ads join -U administrator%ABcd1234

# leave AD
net ads leave -U administrator%ABcd1234

# join specific AD
net ads join -S WIN-2012R2ADC.winadntp.evt -U administrator%ABcd_1234

# leave specific AD
net ads leave -S WIN-2012R2ADC.winadntp.evt -U administrator%ABcd_1234
</file>

====== Error Message ======
<file>
# can not get user information (MIS , England)
getent group : 3m40 + 3m37

# failed to join AD
Failed to join domain: failed to join domain 'WINADNTP.EVT' over rpc: None of the information to be translated has been translated.
--> Delete the computer account of AD

# failed to join AD
[root@nas_8686288_a ~]# net ads join -U administrator%ABcd_1234 -s /etc/samba/net_smb.conf
Failed to join domain: Invalid configuration ("workgroup" set to '', should be 'WINADNTP') and configuration modification was not requested
--> nmblookup -A ip , 沒辦法得到group information?
Ans : 
看起來是客戶將netbios over tcp/ip這個service關掉了, 導致nmblookup -A ip 沒有辦法得到資訊.
打開的方式如下: 
http://172.27.12.189/jerryg/lib/exe/fetch.php?media=netbios_over_tcpip.png

# failed to join AD (not have admin privilege)
n  1 15:47:21 mlmlpppnt03_a ldapOperation[1318]: joinAD result: {'status': 71, 'err': '', 'out': 'Failed to join domain: User specified does not have administrator privileges'}

# account error
joinAD result: {'status': 71, 'err': '', 'out': "Failed to join domain: failed to lookup DC info for domain 'VCPILTPAC.COM' over rpc: Account locked out"}
--> 看起來是帳號沒有辦法使用.?

</file>
